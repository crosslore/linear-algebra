%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The following line fixes a bug that was present in TeXLive 2017 and
% is fixed in TeXLive 2018. It only affected latex, not pdflatex.
\pdfpageheight=\paperheight

%%% Background image
\ifprintcoverfull
  \backgroundsetup{
    scale=1,
    angle=0,
    opacity=1,
    position=current page.north west,
    nodeanchor=north west,
    contents={%
      \includegraphics[height=\paperheight,width=\trimwidth+\bleed]{figures/titlepage-image-print2}%
      \textcolor{spinecolour}{\rule{\spinewidth}{\paperheight}}%
      \includegraphics[height=\paperheight,width=\trimwidth+\bleed]{figures/titlepage-image-print1}%
    }%
  }
\else
  \backgroundsetup{
    scale=1,
    angle=0,
    opacity=1,
    contents={\includegraphics[width=\paperwidth,height=\paperheight]{figures/titlepage-image}}
  }
\fi
\BgThispage

%% No page number
\thispagestyle{empty}

\ifcrownquarto
\newcommand{\subtitlefont}{\fontsize{30}{32}\selectfont}
\newcommand{\titlefont}{\fontsize{46}{53}\selectfont}
\newcommand{\authorfont}{\fontsize{17}{19}\selectfont}
\newcommand{\editionfont}{\fontsize{12}{16}\selectfont}
\newcommand{\licensefont}{\fontsize{11}{11}\selectfont}
\newcommand{\blurbfont}{\fontsize{11pt}{14pt}\selectfont}
\newcommand{\blurbwidth}{4.7in}
\else
\newcommand{\subtitlefont}{\fontsize{34}{36}\selectfont}
\newcommand{\titlefont}{\fontsize{54}{60}\selectfont}
\newcommand{\authorfont}{\fontsize{20}{22}\selectfont}
\newcommand{\editionfont}{\fontsize{14}{18}\selectfont}
\newcommand{\licensefont}{\fontsize{12}{12}\selectfont}
\newcommand{\blurbfont}{\fontsize{12pt}{16pt}\selectfont}
\newcommand{\blurbwidth}{5.2in}
\fi

%% Title Information
\begin{center}
  \textbf{
    \subtitlefont {\textcolor{subtitletextcolour}{\booksubtitle}} \\
    \titlefont {\textcolor{titletextcolour}{\booksubject}} \\[.5\baselineskip]
    \authorfont {\textcolor{subtitletextcolour}{An open text by Peter Selinger}}\smallskip\\
    \editionfont {\textcolor{subtitletextcolour}{Based on the original text by Lyryx Learning and Ken Kuttler}}\bigskip \\[.5\baselineskip]
    % omit edition until Second edition
    \editionfont {\textcolor{subtitletextcolour}{~}} \\
  }
\end{center}

% Spine and back cover
\ifprintcoverfull
  \begin{tikzpicture}[remember picture,overlay]
    \node[outer sep=0in, inner sep=0in, anchor=north] at
    ([yshift=-\bleed-1in,xshift=\bleed+0.5\trimwidth]current page.north west) {
      \begin{minipage}{\blurbwidth}
        \setlength{\parskip}{2ex}
        \blurbfont
        \textbf{\textsf{
          \textcolor{subtitletextcolour}{
            \input{frontmatter/blurb.tex}
          }
        }}
      \end{minipage}
    };
  \end{tikzpicture}
  \begin{tikzpicture}[remember picture,overlay]
    \node[outer sep=0in, inner sep=0in, anchor=center] at
    ([yshift=-\bleed-0.5\trimheight,xshift=\bleed+\trimwidth+0.5\spinewidth]current page.north west) {
      \rotatebox{-90}{%
        \begin{minipage}{\trimheight - 1in}
          \begin{tikzpicture}
            \node[anchor=west] at (0in,0) {
              \fontsize{26}{28}\selectfont {\textcolor{subtitletextcolour}{\textbf{\textsf{\bookfulltitle}}}}
            };
            \node[anchor=east] at (\trimheight - 1in,0) {
              \fontsize{20pt}{22pt}\selectfont {\textcolor{subtitletextcolour}{\textsf{Peter Selinger}}}
            };
          \end{tikzpicture}
        \end{minipage}
      }
    };
  \end{tikzpicture}
\fi

\vfill

% License
\begin{center*}
  \licensefont \textcolor{cctextcolour}{\textbf{Creative Commons License (CC BY)}}%
\end{center*}

